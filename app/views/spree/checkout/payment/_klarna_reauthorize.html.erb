<style type="text/css">
  .align-center {
    width: 100%;
    text-align: center;
  }

  .hiddden {
    display: none;
  }
</style>

<div class="klarna_credit_box"
  data-order-id="<%= @order.number %>"
  data-order-session-id="">
  <fieldset id="order_details">

    <div class="clear"></div>
    <legend align="center">Payment Verification</legend>
    <div class="row">
      <div class="align-center">
        <span class="spiner"><img src="/assets/spinner.gif" /></span>
      </div>
    </div>
  </fieldset>
</div>

<div class="clear"></div>
</br>

<script type="text/javascript" id="klarna­credit­lib­x">
/* <![CDATA[ */
 (function(w, d) {
   var url = 'https://credit.klarnacdn.net/lib/v1/api.js';
    n = d.createElement('script');
    c = d.getElementById('klarna­credit­lib­x');
    n.async = !0;
    n.src = url + '?' + (new Date ()).getTime();
    c.parentNode.replaceChild(n, c);
  })(this, document);
 /* ]]> */
</script>

<script type="text/javascript">
  $.fn.klarnaReauthorize = function(options) {
    var settings = $.extend({
      submitButton: null,
      orderId: null,
      sessionUrl: "/checkout/:id/klarna_reauthorize"
    }, options);

    settings.canvas = this;

    if (!settings.orderId && this.data('orderId') !== undefined) {
      settings.orderId = this.data('orderId');
    }

    if (settings.submitButton) {
      settings.submitCanvas = settings.submitButton.parent().hide();
    }

    // Get a session from the backend and load the form
    var getSession = function () {
      if (settings.clientToken) {
        return;
      }
      $.ajax({
        method: 'POST',
        url: settings.sessionUrl,
        dataType: 'json'
      }).done(function(response) {
        if (response.status) {
          Klarna.Credit.init ({
            client_token: response.token
          });

          settings.canvas.hide();
          settings.submitCanvas.show();

          Klarna.Credit.reauthorize(response.data, {}, function(response) {
            console.log("hey", response)
          });
        } else {
          // redirect back to payments
        }
      });
    }

    getSession();
  }

  $(document).ready(function() {
    $(".klarna_credit_box").klarnaReauthorize({
      submitButton: $("form#checkout_form_confirm input[type='submit']")
    });
  })

</script>
